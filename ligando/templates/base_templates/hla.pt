<html metal:use-macro="load: ../base_layout.pt" lang="${request.locale_name}">

<body>
<metal:block fill-slot="content">

    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1 text-center">
                <h1 id="title">HLA-${hla}</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5 col-md-offset-1">
                <h3>General Information</h3>
                <table class="table table-striped table-bordered">
                    <tr>
                        <td nowrap>Gene name</td>
                        <td id="gene_name"></td>
                    </tr>
                    <tr>
                        <td>Description</td>
                        <td id="description"></td>
                    </tr>
                    <tr>
                        <td>Organism</td>
                        <td id="organism"></td>
                    </tr>
                    <tr>
                        <td>Sequence</td>
                        <td style="word-break:break-all;word-wrap:break-word" id="sequence"></td>
                    </tr>
                    <tr>
                        <td>Uniprot</td>
                        <td id="uniprot"></td>
                    </tr>
                </table>
            </div>


            <div class="col-md-5 col-md-offset-1">
                <h3>Peptide-binding motif</h3>
                <img id="seqlogo" src="" onerror='this.style.display = "none"'>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5 col-md-offset-1">
                <h3>Database Information</h3>
                <table class="table table-striped table-bordered">
                    <tr>
                        <td>Peptides</td>
                        <td id="pep_stat" align="right"></td>
                    </tr>
                    <tr>
                        <td>Sources</td>
                        <td id="source_stat" align="right"></td>
                    </tr>
                </table>
            </div>

            <div class="col-md-5 col-md-offset-1">
                <h3>Distribution of organs</h3>
                <div id="organ_chart" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <table id="example" class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th>Source ID</th>
                        <th>Patient ID</th>
                        <th>Organ</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <script>
        //Gene Information
        $(document).ready(function () {
            document.getElementById("gene_name").innerHTML = ${genes}[0]["gene_name"];
            document.getElementById("description").innerHTML = ${genes}[0]["description"].split("HUMAN")[1].split("OS=")[0];
            document.getElementById("organism").innerHTML = ${genes}[0]["organism"];
            document.getElementById("uniprot").innerHTML = "<a title='Go to Uniprot' class='nostylelink' href='http://www.uniprot.org/uniprot/" + ${genes}[0]["name"] + "'>" + ${genes}[0]["name"] + "</a>";
            document.getElementById("sequence").innerHTML = ${genes}[0]["sequence"];
        });

        //organ pie chart
        $(document).ready(function () {
            $('#organ_chart').highcharts({
                // var options =  {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                credits: {
                    enabled: false
                },
                //TITLE REMOVED TO FIT THEME, NO DIFFERENT FONTS
                title: {
                    text: ''
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.y}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        showInLegend: false,
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y} '
                        }
                    }
                },
                series: [{
                    name: 'Number of sources',
                    colorByPoint: true,
                    point: {
                        events: {
                            click: function () {
                                window.location.href = "/organ/" + this.name;
                            }
                        }
                    },
                    data: ${organ}
                }]
            });
        });


        //DataTable with sources
        $(document).ready(function () {
            // create dataTable
            $('#example').dataTable({
                "paging": true,
                "ordering": false,
                "info": false,
                searching: true,
                data: ${sources},
                columns: [
                    {
                        data: "source_id",
                        "render": function (data, type, row) {
                            return "<a class='nostylelink'  href= '/source_id/" + data + "'>" + data + "</a>";
                        }
                    },
                    {
                        data: "patient_id",
                        "render": function (data, type, row) {
                            return "<a class='nostylelink'  href= '/source/" + data + "'>" + data + "</a>";
                        }
                    },
                    {
                        data: "organ",
                        "render": function (data, type, row) {
                            return "<a class='nostylelink' href= '/organ/" + data + "'>" + data + "</a>";
                        }
                    }
                ]
            });
        });


        $(document).ready(function () {
            // set statistics
            document.getElementById("pep_stat").innerHTML = "<a title='Show all Peptides'  class='nostylelink' href='javascript:post(\x22../peptide_query\x22, {hla_typing: \x22${hla}\x22, grouping:\x22peptide\x22}," + ${statistic}[0]["pep_count"] + " )'> " + ${statistic}[0]["pep_count"] + "</a>";
            document.getElementById("source_stat").innerHTML =${sources}.length;

            // set the corresponding seqlogo
            document.getElementById("seqlogo").src = "${request.static_url("ligando:static/seqlogo/" +hla.replace(":", "") + ".png")}";

        });

    </script>

</metal:block>
</body>

</html>